<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Greece Trip 2026</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0d1b2a;
      color: #e8f0f7;
      height: 100vh;
      overflow: hidden;
    }

    #app {
      display: flex;
      height: 100vh;
    }

    /* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar {
      width: 300px;
      min-width: 300px;
      background: linear-gradient(180deg, #0d1b2a 0%, #122036 100%);
      border-right: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 10;
    }

    #sidebar-header {
      padding: 20px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(135deg, #1a3a5c, #0d2238);
    }

    #sidebar-header .flag { font-size: 22px; margin-bottom: 4px; }

    #sidebar-header h1 {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 0.3px;
    }

    #sidebar-header .subtitle {
      font-size: 11px;
      color: #7eb3d4;
      margin-top: 3px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .trip-stats {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .stat-pill {
      background: rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 4px 10px;
      font-size: 11px;
      color: #9ecae1;
    }

    .stat-pill span { font-weight: 700; color: #fff; }

    #sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 14px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.15) transparent;
    }

    #sidebar-body::-webkit-scrollbar { width: 4px; }
    #sidebar-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

    .filter-section { margin-bottom: 24px; }

    .filter-title {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: #5a8fb5;
      margin-bottom: 10px;
    }

    /* Category filters */
    .cat-filter {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 7px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 4px;
      user-select: none;
    }

    .cat-filter:hover { background: rgba(255,255,255,0.06); }

    .cat-filter.inactive { opacity: 0.38; }

    .cat-badge {
      width: 28px;
      height: 28px;
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .cat-label {
      font-size: 12.5px;
      color: #d0e8f5;
      flex: 1;
    }

    .cat-count {
      font-size: 11px;
      color: #4a7a9b;
      min-width: 20px;
      text-align: right;
    }

    .cat-check {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1.5px solid rgba(255,255,255,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .cat-filter.active .cat-check {
      background: #4a90d9;
      border-color: #4a90d9;
    }

    .cat-check-mark {
      color: white;
      font-size: 10px;
      display: none;
    }

    .cat-filter.active .cat-check-mark { display: block; }

    /* Person filters */
    .people-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .person-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
    }

    .person-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 2.5px solid rgba(255,255,255,0.2);
      /* Zoom tight so the face fills the circle */
      background-size: 250%;
      background-position: center 18%;
      background-color: #1a3a5c;
      transition: all 0.15s;
      overflow: hidden;
      flex-shrink: 0;
    }

    .person-btn.active .person-avatar {
      border-color: white;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.28);
    }

    .person-btn.inactive .person-avatar {
      opacity: 0.28;
      filter: grayscale(70%);
    }

    .person-name {
      font-size: 8.5px;
      color: #5a8fb5;
      text-align: center;
      white-space: nowrap;
      transition: color 0.15s;
      letter-spacing: 0.2px;
    }

    .person-btn.active .person-name { color: #9ecae1; }

    /* Legend */
    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 11.5px;
      color: #7eb3d4;
    }

    .legend-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    /* Results counter */
    #results-bar {
      padding: 10px 14px;
      background: rgba(0,0,0,0.2);
      border-top: 1px solid rgba(255,255,255,0.06);
      font-size: 11px;
      color: #5a8fb5;
    }

    #results-bar strong { color: #9ecae1; }

    /* â”€â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #map {
      flex: 1;
      height: 100vh;
      background: #0d1b2a;
    }

    /* â”€â”€â”€ CUSTOM MARKER STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .photo-icon {
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.45);
      transition: transform 0.1s;
      cursor: pointer;
    }

    .photo-thumb-icon {
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      cursor: pointer;
    }

    .photo-thumb-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .coffee-icon {
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2.5px solid rgba(255,255,255,0.9);
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      cursor: pointer;
      background: #5c3317;
    }

    /* â”€â”€â”€ POPUPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .leaflet-popup-content-wrapper {
      background: #162236;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      padding: 0;
      overflow: hidden;
    }

    .leaflet-popup-content {
      margin: 0;
      color: #e8f0f7;
      min-width: 240px;
      max-width: 320px;
    }

    .leaflet-popup-tip-container { margin-top: -1px; }
    .leaflet-popup-tip { background: #162236; }
    .leaflet-popup-close-button { color: #7eb3d4 !important; top: 10px !important; right: 12px !important; font-size: 18px !important; }
    .leaflet-popup-close-button:hover { color: white !important; }

    /* Photo popup */
    .photo-popup-thumb {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      display: block;
    }

    .photo-popup-body {
      padding: 12px 14px 14px;
    }

    .popup-date {
      font-size: 11px;
      color: #5a8fb5;
      margin-bottom: 4px;
    }

    .popup-category {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      margin-top: 6px;
    }

    /* Coffee popup */
    .coffee-popup {
      padding: 0;
    }

    .coffee-popup-header {
      background: linear-gradient(135deg, #3b1f0c, #5c3317);
      padding: 12px 14px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .coffee-cup-big {
      font-size: 28px;
      line-height: 1;
    }

    .coffee-popup-header-text h3 {
      font-size: 14px;
      font-weight: 700;
      color: #f5e6d0;
      margin-bottom: 2px;
    }

    .coffee-popup-header-text .coffee-date {
      font-size: 11px;
      color: #c49a6c;
    }

    .coffee-popup-body {
      padding: 12px 14px;
    }

    .coffee-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 7px;
      font-size: 12px;
    }

    .coffee-row-icon { font-size: 13px; flex-shrink: 0; margin-top: 1px; }

    .coffee-row-label {
      color: #7eb3d4;
      min-width: 65px;
      flex-shrink: 0;
    }

    .coffee-row-value {
      color: #d0e8f5;
      flex: 1;
    }

    .coffee-score {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(245, 200, 66, 0.15);
      border: 1px solid rgba(245, 200, 66, 0.3);
      border-radius: 8px;
      padding: 2px 8px;
      font-size: 13px;
      font-weight: 700;
      color: #f5c842;
    }

    .coffee-comments {
      margin-top: 8px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.04);
      border-radius: 7px;
      font-size: 11.5px;
      color: #9ecae1;
      font-style: italic;
      line-height: 1.5;
    }

    /* Cluster popup grid */
    .cluster-popup { padding: 12px 14px; }
    .cluster-popup h4 {
      font-size: 12px;
      color: #7eb3d4;
      margin-bottom: 10px;
    }

    .cluster-thumb-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }

    .cluster-thumb {
      aspect-ratio: 1;
      border-radius: 5px;
      overflow: hidden;
      cursor: pointer;
    }

    .cluster-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .cluster-more {
      font-size: 11px;
      color: #5a8fb5;
      margin-top: 8px;
      text-align: center;
    }

    /* Lightbox */
    #lightbox {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    #lightbox.visible { display: flex; }

    #lightbox img {
      max-width: 90vw;
      max-height: 85vh;
      border-radius: 8px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.8);
    }

    #lightbox-close {
      position: absolute;
      top: 20px;
      right: 24px;
      font-size: 30px;
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      line-height: 1;
    }

    #lightbox-close:hover { color: white; }

    #lightbox-caption {
      margin-top: 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }

    /* Route line pulse */
    .route-line { stroke-dasharray: 8, 6; }

    /* MarkerCluster overrides */
    .marker-cluster-small,
    .marker-cluster-medium,
    .marker-cluster-large {
      background-color: rgba(26, 82, 118, 0.7) !important;
    }

    .marker-cluster-small div,
    .marker-cluster-medium div,
    .marker-cluster-large div {
      background-color: rgba(41, 128, 185, 0.85) !important;
      color: white !important;
      font-weight: 700;
      font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      #sidebar { width: 260px; min-width: 260px; }
    }
  </style>
</head>
<body>
<div id="app">

  <!-- â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside id="sidebar">
    <div id="sidebar-header">
      <div class="flag">ğŸ‡¬ğŸ‡· ğŸ‡²ğŸ‡° ğŸ‡¹ğŸ‡·</div>
      <h1>Greece Trip 2026</h1>
      <div class="subtitle">Feb 14 â€“ 22 Â· Istanbul â†’ Athens â†’ Ohrid â†’ Aegina</div>
      <div class="trip-stats">
        <div class="stat-pill"><span id="stat-photos">117</span> photos</div>
        <div class="stat-pill"><span>16</span> coffees</div>
        <div class="stat-pill"><span>8</span> days</div>
      </div>
    </div>

    <div id="sidebar-body">

      <!-- Categories -->
      <div class="filter-section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div class="filter-title" style="margin-bottom:0;">ğŸ“ Location Type</div>
          <button onclick="toggleAllCategories()" style="background:rgba(255,255,255,0.07);border:none;color:#5a8fb5;font-size:10px;padding:3px 8px;border-radius:5px;cursor:pointer;letter-spacing:0.5px;" id="cat-toggle-btn">NONE</button>
        </div>
        <div id="category-filters"></div>
      </div>

      <!-- People -->
      <div class="filter-section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div class="filter-title" style="margin-bottom:0;">ğŸ‘¤ People</div>
          <button onclick="selectAllPeople()" style="background:rgba(255,255,255,0.07);border:none;color:#5a8fb5;font-size:10px;padding:3px 8px;border-radius:5px;cursor:pointer;letter-spacing:0.5px;">ALL</button>
        </div>
        <div class="people-grid" id="person-filters"></div>
      </div>

      <!-- Legend -->
      <div class="filter-section">
        <div class="filter-title">ğŸ—ºï¸ Map Legend</div>
        <div class="legend-row">
          <div class="legend-icon" style="background:#1a5276;">ğŸ“·</div>
          <span>Photo location (clustered)</span>
        </div>
        <div class="legend-row">
          <div class="legend-icon" style="background:#5c3317;">â˜•</div>
          <span>Coffee consumed</span>
        </div>
        <div class="legend-row">
          <div style="width:22px;height:3px;background:#4a90d9;border-radius:2px;"></div>
          <span>Driving route</span>
        </div>
        <div class="legend-row">
          <div style="width:22px;height:3px;background:#e8a020;border-radius:2px;opacity:0.8;"></div>
          <span>Flight</span>
        </div>
        <div class="legend-row">
          <div style="width:22px;height:3px;background:#56d6f0;border-radius:2px;opacity:0.8;"></div>
          <span>Ferry</span>
        </div>
      </div>

    </div>

    <div id="results-bar">
      Showing <strong id="visible-count">â€”</strong> of <strong id="total-count">â€”</strong> photos
    </div>
  </aside>

  <!-- â”€â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="map"></div>

</div>

<!-- Lightbox -->
<div id="lightbox">
  <div id="lightbox-close" onclick="closeLightbox()">Ã—</div>
  <img id="lightbox-img" src="" alt="">
  <div id="lightbox-caption"></div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="data.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CATEGORIES = [
  { id: "Monasteries & Churches", icon: "â›ª", color: "#8e44ad", bg: "rgba(142,68,173,0.25)" },
  { id: "Ancient Sites",          icon: "ğŸ›ï¸", color: "#c0392b", bg: "rgba(192,57,43,0.25)" },
  { id: "Natural Scenery",        icon: "ğŸŒ„", color: "#27ae60", bg: "rgba(39,174,96,0.25)" },
  { id: "Coastal & Islands",      icon: "ğŸï¸", color: "#2980b9", bg: "rgba(41,128,185,0.25)" },
  { id: "Towns & Architecture",   icon: "ğŸ™ï¸", color: "#d35400", bg: "rgba(211,84,0,0.25)" },
  { id: "People & Portraits",     icon: "ğŸ‘¤", color: "#7f8c8d", bg: "rgba(127,140,141,0.25)" },
  { id: "Travel & Transit",       icon: "âœˆï¸", color: "#2c3e50", bg: "rgba(44,62,80,0.25)" },
];

const CATEGORY_MAP = {};
CATEGORIES.forEach(c => { CATEGORY_MAP[c.id] = c; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let activeCategories = new Set(CATEGORIES.map(c => c.id));
let activePeople = new Set(PEOPLE.map((_, i) => i));
let currentZoom = 6;
let photoMarkers = [];       // {marker, photo, layer}
let coffeeMarkers = [];
let clusterGroup = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const map = L.map('map', {
  center: [39.5, 23.0],
  zoom: 6,
  zoomControl: true,
  attributionControl: true,
});

// Carto Voyager tiles â€” clean, modern
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 20
}).addTo(map);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTE LINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** Generate a smooth arc between two [lat,lng] points */
function greatCircleArc(from, to, steps) {
  const pts = [];
  for (let i = 0; i <= steps; i++) {
    const t = i / steps;
    const lat = from[0] + (to[0] - from[0]) * t;
    const lng = from[1] + (to[1] - from[1]) * t;
    const bow = Math.sin(Math.PI * t) * 1.8;   // slight northward bow
    pts.push([lat + bow, lng]);
  }
  return pts;
}


function drawRoute() {
  const s = ROUTE_SEGMENTS;

  // â”€â”€ 1. Flight: Istanbul â†’ Athens (curved arc, amber/orange)
  const flightArc = greatCircleArc(s.flight[0], s.flight[1], 30);
  L.polyline(flightArc, {
    color: '#e8a020', weight: 2, dashArray: '5 9',
    lineCap: 'round', opacity: 0.75, interactive: false,
  }).addTo(map);

  // â”€â”€ 2. Driving segments (road-following, blue dashed)
  [s.drive1, s.drive2, s.drive3].forEach(pts => {
    L.polyline(pts, {
      color: 'rgba(74,144,217,0.15)', weight: 7, lineCap: 'round', interactive: false,
    }).addTo(map);
    L.polyline(pts, {
      color: '#4a90d9', weight: 2.5, dashArray: '10 6',
      lineCap: 'round', lineJoin: 'round', opacity: 0.88, interactive: false,
    }).addTo(map);
  });

  // â”€â”€ 3. Ferry: Athens/Piraeus â†’ Aegina (dotted cyan)
  L.polyline(s.ferry, {
    color: '#56d6f0', weight: 2, dashArray: '4 7',
    lineCap: 'round', opacity: 0.75, interactive: false,
  }).addTo(map);

  // â”€â”€ Trip start/end markers
  L.circleMarker(s.flight[0], {
    radius: 6, fillColor: '#2ecc71', color: 'white', weight: 2, fillOpacity: 1, interactive: false,
  }).addTo(map);
  L.circleMarker([37.9355, 23.9475], {   // Athens airport end
    radius: 6, fillColor: '#e74c3c', color: 'white', weight: 2, fillOpacity: 1, interactive: false,
  }).addTo(map);

}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ICON FACTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getIconSize() {
  const z = map.getZoom() || 6;
  if (z <= 7)  return 24;
  if (z <= 10) return 30;
  if (z <= 13) return 38;
  return 46;
}

function createPhotoIcon(photo, size) {
  const z = map.getZoom();
  const cat = CATEGORY_MAP[photo.category] || CATEGORIES[0];

  // At high zoom, show thumbnail
  if (z >= 14) {
    const s = size;
    return L.divIcon({
      className: '',
      html: `<div class="photo-thumb-icon" style="width:${s}px;height:${s}px;">
               <img src="Photos/${photo.filename}" loading="lazy" alt="">
             </div>`,
      iconSize: [size, size],
      iconAnchor: [size/2, size/2],
      popupAnchor: [0, -size/2 - 4],
    });
  }

  // Camera icon with category color
  return L.divIcon({
    className: '',
    html: `<div class="photo-icon" style="width:${size}px;height:${size}px;background:${cat.color};font-size:${Math.round(size*0.52)}px;">ğŸ“·</div>`,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2 - 4],
  });
}

function createCoffeeIcon(size) {
  return L.divIcon({
    className: '',
    html: `<div class="coffee-icon" style="width:${size}px;height:${size}px;font-size:${Math.round(size*0.55)}px;">â˜•</div>`,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2 - 4],
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POPUP BUILDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function formatDate(dt) {
  if (!dt) return '';
  const [datePart, timePart] = dt.split('T');
  const [y, m, d] = datePart.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const time = timePart ? timePart.slice(0,5) : '';
  return `${months[parseInt(m)-1]} ${parseInt(d)}, ${y}${time ? ' Â· ' + time : ''}`;
}

function buildPhotoPopup(photo) {
  const cat = CATEGORY_MAP[photo.category] || CATEGORIES[0];
  return `
    <img class="photo-popup-thumb" src="Photos/${photo.filename}" 
         onclick="openLightbox('Photos/${photo.filename}','${formatDate(photo.datetime)}')"
         style="cursor:zoom-in;" alt="">
    <div class="photo-popup-body">
      <div class="popup-date">${formatDate(photo.datetime)}</div>
      <div class="popup-category" style="background:${cat.bg};color:${cat.color};">
        ${cat.icon} ${cat.id}
      </div>
    </div>`;
}

function buildClusterPopup(photos) {
  const shown = photos.slice(0, 9);
  const extra = photos.length - shown.length;
  const thumbs = shown.map(p =>
    `<div class="cluster-thumb">
       <img src="Photos/${p.filename}" loading="lazy" alt=""
            onclick="openLightbox('Photos/${p.filename}','${formatDate(p.datetime)}')"
            style="cursor:zoom-in;">
     </div>`
  ).join('');
  return `
    <div class="cluster-popup">
      <h4>${photos.length} photos in this area</h4>
      <div class="cluster-thumb-grid">${thumbs}</div>
      ${extra > 0 ? `<div class="cluster-more">+${extra} more</div>` : ''}
    </div>`;
}

function buildCoffeePopup(c) {
  const dt = c.date ? `${c.date}${c.time ? ' Â· ' + c.time : ''}` : '';
  const formatVal = v => v && v !== 'Unknown' && v !== '' ? v : null;

  const row = (icon, label, val) => formatVal(val)
    ? `<div class="coffee-row"><span class="coffee-row-icon">${icon}</span><span class="coffee-row-label">${label}</span><span class="coffee-row-value">${val}</span></div>`
    : '';

  return `
    <div class="coffee-popup">
      <div class="coffee-popup-header">
        <div class="coffee-cup-big">â˜•</div>
        <div class="coffee-popup-header-text">
          <h3>${c.drinkType || 'Coffee'}</h3>
          <div class="coffee-date">ğŸ“ ${c.location}${dt ? '<br>' + dt : ''}</div>
        </div>
      </div>
      <div class="coffee-popup-body">
        ${row('ğŸŒ', 'Origin', c.country)}
        ${row('ğŸŒ¿', 'Farm', c.farm)}
        ${row('ğŸƒ', 'Variety', c.variety)}
        ${row('ğŸ”¥', 'Roaster', c.roaster)}
        ${row('âš—ï¸', 'Process', c.processing)}
        ${row('â˜•', 'Brew', c.brewType)}
        ${(c.grinder && c.grinder !== 'Unknown' && c.grinder !== '') ? `<div class="coffee-row"><span class="coffee-row-icon">âš™ï¸</span><span class="coffee-row-label">Grinder</span><span class="coffee-row-value">${c.grinder}${c.grindSize ? ' Â· size ' + c.grindSize : ''}</span></div>` : ''}
        ${c.score ? `<div class="coffee-row" style="margin-top:8px;"><span class="coffee-row-icon">â­</span><span class="coffee-row-label">Score</span><span class="coffee-score">${c.score} / 10</span></div>` : ''}
        ${c.retailPerLb ? `<div class="coffee-row"><span class="coffee-row-icon">ğŸ’°</span><span class="coffee-row-label">Price</span><span class="coffee-row-value">$${c.retailPerLb}/lb</span></div>` : ''}
        ${c.comments ? `<div class="coffee-comments">"${c.comments}"</div>` : ''}
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKER CLUSTER GROUP (custom icon function)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function makeClusterGroup() {
  return L.markerClusterGroup({
    maxClusterRadius: function(zoom) {
      if (zoom <= 7)  return 80;
      if (zoom <= 10) return 60;
      if (zoom <= 13) return 40;
      return 20;
    },
    iconCreateFunction: function(cluster) {
      const count = cluster.getChildCount();
      const z = map.getZoom();
      const size = z <= 7 ? 38 : z <= 10 ? 46 : z <= 13 ? 54 : 60;
      const fontSize = z <= 7 ? 12 : z <= 10 ? 13 : 14;

      return L.divIcon({
        className: '',
        html: `<div style="
          width:${size}px;height:${size}px;
          background:radial-gradient(circle, rgba(41,128,185,0.9) 0%, rgba(26,82,118,0.9) 100%);
          border-radius:50%;
          display:flex;align-items:center;justify-content:center;
          border:2.5px solid rgba(255,255,255,0.8);
          box-shadow:0 3px 12px rgba(0,0,0,0.5);
          flex-direction:column;
          color:white;font-weight:700;
        ">
          <span style="font-size:${fontSize}px;line-height:1.1;">${count}</span>
          <span style="font-size:9px;opacity:0.85;">ğŸ“·</span>
        </div>`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
      });
    },
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    animate: true,
    chunkedLoading: true,
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD PHOTO MARKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildPhotoMarkers() {
  photoMarkers = [];

  PHOTO_DATA.forEach(photo => {
    if (!photo.lat || !photo.lng) return;

    const size = getIconSize();
    const icon = createPhotoIcon(photo, size);
    const marker = L.marker([photo.lat, photo.lng], { icon });

    marker.bindPopup(() => buildPhotoPopup(photo), {
      maxWidth: 320,
      className: 'photo-popup-wrapper',
    });

    photoMarkers.push({ marker, photo });
  });
}

function addCoffeeMarkers() {
  const size = getIconSize();

  COFFEE_DATA.forEach(c => {
    if (!c.lat || !c.lng) return;

    const marker = L.marker([c.lat, c.lng], {
      icon: createCoffeeIcon(size),
      zIndexOffset: 1000,
    });

    marker.bindPopup(buildCoffeePopup(c), {
      maxWidth: 340,
      className: 'coffee-popup-wrapper',
    });

    coffeeMarkers.push(marker);
    marker.addTo(map);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER & RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ALL_PEOPLE_COUNT = PEOPLE.length;

function isPhotoVisible(photo) {
  // Category filter always applies
  if (!activeCategories.has(photo.category)) return false;

  // Person filter:
  // If ALL people selected â†’ show everything (including untagged photos)
  if (activePeople.size === ALL_PEOPLE_COUNT) return true;

  // If no people selected â†’ show nothing
  if (activePeople.size === 0) return false;

  // Subset selected: show only photos where at least one selected person is detected.
  // Photos with no person detected are hidden when filtering by person.
  if (photo.persons.length === 0) return false;
  return photo.persons.some(p => activePeople.has(p));
}

function renderMarkers() {
  // Remove old cluster group
  if (clusterGroup) {
    map.removeLayer(clusterGroup);
  }

  clusterGroup = makeClusterGroup();

  const visible = [];
  photoMarkers.forEach(({ marker, photo }) => {
    if (isPhotoVisible(photo)) {
      visible.push({ marker, photo });
    }
  });

  // At high-ish zoom, show photo grid popup instead of just zooming
  clusterGroup.on('clusterclick', function(e) {
    const zoom = map.getZoom();
    if (zoom >= 10) {
      const childMarkers = e.layer.getAllChildMarkers();
      const photos = childMarkers.map(m => m._photo).filter(Boolean);
      if (photos.length > 0 && photos.length <= 20) {
        e.layer.bindPopup(buildClusterPopup(photos), { maxWidth: 360 }).openPopup();
        L.DomEvent.stopPropagation(e);
        return false;
      }
    }
  });

  visible.forEach(({ marker, photo }) => {
    marker._photo = photo;
    clusterGroup.addLayer(marker);
  });

  clusterGroup.addTo(map);

  // Update counts
  const totalWithGPS = PHOTO_DATA.filter(p => p.lat).length;
  document.getElementById('visible-count').textContent = visible.length;
  document.getElementById('total-count').textContent = totalWithGPS;
  document.getElementById('stat-photos').textContent = totalWithGPS;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ZOOM-BASED ICON SCALING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

map.on('zoomend', function() {
  const newZoom = map.getZoom();
  const prevZoom = currentZoom;
  currentZoom = newZoom;

  const size = getIconSize();

  // Update coffee icons
  coffeeMarkers.forEach(m => {
    m.setIcon(createCoffeeIcon(size));
  });

  // Rebuild photo icons (always â€” to handle thumbnail/icon switch at zoom 14)
  photoMarkers.forEach(({ marker, photo }) => {
    marker.setIcon(createPhotoIcon(photo, size));
  });

  // Refresh cluster group to update cluster icons
  if (clusterGroup) {
    clusterGroup.refreshClusters();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR: CATEGORY FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildCategoryFilters() {
  const container = document.getElementById('category-filters');
  const counts = {};
  PHOTO_DATA.forEach(p => { counts[p.category] = (counts[p.category] || 0) + 1; });

  CATEGORIES.forEach(cat => {
    const count = counts[cat.id] || 0;
    const el = document.createElement('div');
    el.className = 'cat-filter active';
    el.dataset.catId = cat.id;
    el.innerHTML = `
      <div class="cat-badge" style="background:${cat.bg};">${cat.icon}</div>
      <span class="cat-label">${cat.id}</span>
      <span class="cat-count">${count}</span>
      <div class="cat-check"><span class="cat-check-mark">âœ“</span></div>
    `;
    el.addEventListener('click', () => toggleCategory(cat.id, el));
    container.appendChild(el);
  });
}

function toggleCategory(catId, el) {
  const isOnlyActive = activeCategories.size === 1 && activeCategories.has(catId);

  if (isOnlyActive) {
    // Already the sole selection â€” reset to all
    CATEGORIES.forEach(c => activeCategories.add(c.id));
    document.querySelectorAll('.cat-filter').forEach(e => {
      e.classList.add('active');
      e.classList.remove('inactive');
    });
  } else {
    // Select only this one, deselect all others
    activeCategories.clear();
    activeCategories.add(catId);
    document.querySelectorAll('.cat-filter').forEach(e => {
      const isThis = e.dataset.catId === catId;
      e.classList.toggle('active', isThis);
      e.classList.toggle('inactive', !isThis);
    });
  }
  renderMarkers();
}

let allCatsActive = true;
function toggleAllCategories() {
  const btn = document.getElementById('cat-toggle-btn');
  if (activeCategories.size === CATEGORIES.length) {
    activeCategories.clear();
    document.querySelectorAll('.cat-filter').forEach(el => {
      el.classList.remove('active');
      el.classList.add('inactive');
    });
    btn.textContent = 'ALL';
    allCatsActive = false;
  } else {
    CATEGORIES.forEach(c => activeCategories.add(c.id));
    document.querySelectorAll('.cat-filter').forEach(el => {
      el.classList.remove('inactive');
      el.classList.add('active');
    });
    btn.textContent = 'NONE';
    allCatsActive = true;
  }
  renderMarkers();
}

function selectAllPeople() {
  activePeople = new Set(PEOPLE.map((_, i) => i));
  document.querySelectorAll('.person-btn').forEach(b => {
    b.classList.add('active');
    b.classList.remove('inactive');
  });
  renderMarkers();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR: PERSON FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildPersonFilters() {
  const container = document.getElementById('person-filters');

  PEOPLE.forEach((person, idx) => {
    const el = document.createElement('div');
    el.className = 'person-btn active';
    el.dataset.personIdx = idx;
    // Count how many trip photos contain this person
    const count = PHOTO_DATA.filter(p => p.persons.includes(idx)).length;
    el.innerHTML = `
      <div class="person-avatar"
           style="background-image:url('${person.avatar}');border-color:${person.color}80;">
      </div>
      <div class="person-name">${person.name}</div>
    `;
    el.title = `${person.name} â€” ${count} photo${count !== 1 ? 's' : ''}`;
    el.addEventListener('click', () => togglePerson(idx, el));
    container.appendChild(el);
  });
}

function togglePerson(idx, el) {
  const isOnlyActive = activePeople.size === 1 && activePeople.has(idx);

  if (isOnlyActive) {
    // Already the sole selection â€” reset to all
    selectAllPeople();
  } else {
    // Select only this one, deselect all others
    activePeople.clear();
    activePeople.add(idx);
    document.querySelectorAll('.person-btn').forEach(b => {
      const isThis = parseInt(b.dataset.personIdx) === idx;
      b.classList.toggle('active', isThis);
      b.classList.toggle('inactive', !isThis);
    });
    renderMarkers();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openLightbox(src, caption) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox-caption').textContent = caption || '';
  document.getElementById('lightbox').classList.add('visible');
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('visible');
  document.getElementById('lightbox-img').src = '';
}

document.getElementById('lightbox').addEventListener('click', function(e) {
  if (e.target === this) closeLightbox();
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeLightbox();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIT MAP TO DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function fitMapToBounds() {
  const allPoints = PHOTO_DATA
    .filter(p => p.lat)
    .map(p => [p.lat, p.lng]);

  COFFEE_DATA
    .filter(c => c.lat)
    .forEach(c => allPoints.push([c.lat, c.lng]));

  if (allPoints.length > 0) {
    const bounds = L.latLngBounds(allPoints);
    map.fitBounds(bounds, { padding: [40, 40] });
  } else {
    map.setView([39.5, 23.0], 6);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function init() {
  buildCategoryFilters();
  buildPersonFilters();
  drawRoute();
  buildPhotoMarkers();
  addCoffeeMarkers();
  renderMarkers();
  fitMapToBounds();
})();
</script>

</body>
</html>
